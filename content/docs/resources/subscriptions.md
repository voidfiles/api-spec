# Subscriptions

**NOT YET IMPLEMENTED** - still seeking comment on these from developers.

## General Information

App.net allows Apps to subscribe to updates when data changes in our system. When an event that you've subscribed to happens, we'll
POST to a callback url that you have registered with us. That way, your App can know about the most recent data in an efficient and
immediate way.

*Note: this process is sometimes called 'WebHooks'*

### What information can I subscribe to?

When you create a subscription, you're telling us that you want information when an object is updated in a specific way.

For instance you may be interested in knowing that a **User** started **following** another User. Or you may want to know
when a **User** is **mentioned** in a Post. Or maybe you want to know when a **User** is **replied** to.

These examples illustrate that you can receive an update when a certain ```aspect``` of an ```object``` changes.

#### We currently support the following subscriptions

* User
    * follow: the subscribed to User started following a User
    * followed_by: a User started following the subscribed to User
    * mention: a Post was written that mentions the subscribed to User
    * profile_update: the profile of the subscribed to User was updated
    * post: a Post was written by the subscribed to User
    * replies_to: a Post was written in reply to one of the subscribed to User's posts

### How do I get started?

1. Create an App
2. [Create a callback URL](#callback-format)
3. [Create a subscription](#create-a-subscription)
4. [Receive updates](#receive-an-update)

#### Callback Format

A callback url is a url that your App controls that is able to receive GET and POST requests from App.net.

*Note: you must include the scheme (http/https) when creating a subscription.*

##### Subscription creation and verification

When you [create a subscription](#create-a-subscription), App.net will submit a GET request to your callback URL to verify that you
control it. This is based on the Pubsubhubbub challenge flow. App.net will send the following parameters to your callback URL:

* **hub.mode**: "subscribe"
* **hub.topic**: A string representing what the app is subscribing to in the form of "object.aspect". For example, "user.post".
* **hub.challenge**: A string randomly generated by App.net that the callback url must return before the subscription is valid.
* **hub.verify_token**: The string the App provided to App.net in the subscription request.

> YOUR_CALLBACK_URL?hub.mode=subscribe&hub.topic=user.post&hub.challenge=0x12fh47djtufhdjfu85e&hub.verify_token=YOUR_VERIFY_TOKEN

We must receive a ```200 OK``` response from your callback url with only the ```hub.challenge``` in the body.

> 0x12fh47djtufhdjfu85e

Once we verify your subscription, your original subscription request will return with a ```201 Created``` if successful or an
appropriate HTTP error. If the subscription was successful, the response will include a ```Location``` header representing the newly
created subscription.

##### Receive an update

When you have an active subscription, if data that you subscribe to changes we will send you a POST request informing you of this
update. These updates are notices only and will not contain the new values or data. Your app will have to decide how to response to
this information.

When App.net sends you updates, we will post a JSON string of the following format. *Note: this is a list of updates that have
occurred*.

```js
{
    "data": [
        {
            "subscription_id": "1",
            "object": "user",
            "aspect": "post",
            "object_id": "1",
            "time": "2012-07-19T23:59:51Z"
        },
        {
            "subscription_id": "2",
            "object": "user",
            "aspect": "mention",
            "object_id": "3",
            "time": "2012-07-20T00:00:31Z"
        }
    ],
    "meta": {
        "code": 200
    }
}
```

When we send your app updates, we will also include a authentication header so you can verify the update is coming from App.net and
hasn't been tampered. We will set 

```X-Hub-Signature: sha1=signature```

where ```signature``` is a SHA1 signature computed with the HMAC algorithm where the request body is the data and your app's secret
is the key. When you receive an update, you should calculate the HMAC and return a ```200 OK``` if the HMAC matches. If the HMAC
doesn't match, return a ```400 BAD REQUEST``` and ignore the update.

## List Subscriptions

List all the Subscriptions this app is currently subscribed to. **This resource must be accessed with an App access token**.

> This endpoint is currently migrated by the ```response_envelope``` migration. Please refer to the [Migrations documentation](/appdotnet/api-spec/blob/master/migrations.md#current-migrations) for more info.

### URL
> https://alpha-api.app.net/stream/0/subscriptions

### Parameters

None

### Example

> GET https://alpha-api.app.net/stream/0/subscriptions
```js
{
    "data": [
        {
            "id": "1"
            "object": "user",
            "aspect": "post",
            "callback_url": "https://example.com/webhooks/app_net",
            "created_at": "2012-07-20T00:18:55Z"
        },
        {
            "id": "2"
            "object": "user",
            "aspect": "mention",
            "callback_url": "https://example.com/webhooks/app_net",
            "created_at": "2012-07-20T00:18:56Z"
        }
    ],
    "meta": {
        "code": 200
    }
}
```

## Create a Subscription

Create a new subscription. Returns either ```201 CREATED``` or an error status code. Please read the [general subscription information](#general-information) to understand the entire subscription process.
**This resource must be accessed with an App access token**.

> This endpoint is currently migrated by the ```response_envelope``` migration. Please refer to the [Migrations documentation](/appdotnet/api-spec/blob/master/migrations.md#current-migrations) for more info.

### URL
> https://alpha-api.app.net/stream/0/subscriptions

### Data

<table>
    <thead>
        <tr>
            <th>Name</th>
            <th>Required?</th>
            <th>Type</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>object</code></td>
            <td>Required</td>
            <td>string</td>
            <td>The objects your app wants subscriptions about. Currently only <code>user</code></td>
        </tr>
        <tr>
            <td><code>aspect</code></td>
            <td>Required</td>
            <td>string</td>
            <td>What kind of updates you want to know about. See <a href="#we-currently-support-the-following-subscriptions">our currently supported subscriptions</a>.</td>
        </tr>
        <tr>
            <td><code>callback_url</code></td>
            <td>Required</td>
            <td>string</td>
            <td>A fully qualified URL that specifies where an app would like to receive updates. It can be either http or https and must not include a fragment.</td>
        </tr>
        <tr>
            <td><code>verify_token</code></td>
            <td>Optional</td>
            <td>string</td>
            <td>A string of at most 200 characters that will be provided to your callback url so it can distinguish multiple subscription requests at once.</td>
        </tr>
    </tbody>
</table>

### Example

> POST https://alpha-api.app.net/stream/0/subscriptions
>
> DATA object=user&verify_token=user%3Apost&aspect=post&callback_url=https%3A%2F%2Fexample.com%2Fwebhooks%2Fapp_net
```js
{
    "data": {
        "id": "1"
        "object": "user",
        "aspect": "post",
        "callback_url": "https://example.com/webhooks/app_net",
        "created_at": "2012-07-20T00:18:55Z"
    },
    "meta": {
        "code": 200
    }
}
```

## Delete a Subscription

Delete a single subscription. Returns the deleted subscription. **This resource must be accessed with an App access token**.

*Remember, access tokens can not be passed in a HTTP body for ```DELETE``` requests. Please refer to the [authentication documentation](/appdotnet/api-spec/blob/master/auth.md#authenticated-api-requests).*

> This endpoint is currently migrated by the ```response_envelope``` migration. Please refer to the [Migrations documentation](/appdotnet/api-spec/blob/master/migrations.md#current-migrations) for more info.

### URL
> https://alpha-api.app.net/stream/0/subscriptions/[subscription_id]

### Data

<table>
    <thead>
        <tr>
            <th>Name</th>
            <th>Required?</th>
            <th>Type</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>subscription_id</code></td>
            <td>Required</td>
            <td>string</td>
            <td>The subscription id</td>
        </tr>
    </tbody>
</table>

### Example

> DELETE https://alpha-api.app.net/stream/0/subscriptions/1
```js
{
    "data": {
        "id": "1"
        "object": "user",
        "aspect": "post",
        "callback_url": "https://example.com/webhooks/app_net",
        "created_at": "2012-07-20T00:18:55Z"
    },
    "meta": {
        "code": 200
    }
}
```

## Delete all Subscription

Delete all subscriptions for the authorized App. Returns a list of the deleted subscriptions.
**This resource must be accessed with an App access token**.

*Remember, access tokens can not be passed in a HTTP body for ```DELETE``` requests. Please refer to the [authentication documentation](/appdotnet/api-spec/blob/master/auth.md#authenticated-api-requests).*

> This endpoint is currently migrated by the ```response_envelope``` migration. Please refer to the [Migrations documentation](/appdotnet/api-spec/blob/master/migrations.md#current-migrations) for more info.

### URL
> https://alpha-api.app.net/stream/0/subscriptions

### Data

None

### Example

> DELETE https://alpha-api.app.net/stream/0/subscriptions
```js
{
    "data": [
        {
            "id": "1"
            "object": "user",
            "aspect": "post",
            "callback_url": "https://example.com/webhooks/app_net",
            "created_at": "2012-07-20T00:18:55Z"
        },
        {
            "id": "2"
            "object": "user",
            "aspect": "mention",
            "callback_url": "https://example.com/webhooks/app_net",
            "created_at": "2012-07-20T00:18:56Z"
        }
    ],
    "meta": {
        "code": 200
    }
}
```
